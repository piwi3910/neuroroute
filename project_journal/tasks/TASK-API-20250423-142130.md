# Task: Refactor Router Service

**Task ID:** TASK-API-20250423-142130  
**Status:** Completed
**Coordinator:** TASK-CMD-20250423-141900  
**Assigned To:** api-developer  

## Goal

Refactor the existing router service to split it into two distinct components: a routing engine and a normalization engine, following the new flow architecture. This will improve modularity and allow for more flexible routing and normalization strategies.

## Acceptance Criteria

1. Split the current router service into routing engine and normalization engine components
2. Implement pluggable routing strategies with the current rules-based strategy as default
3. Implement model-specific normalization with format conversion logic
4. Ensure backward compatibility with existing code
5. Add appropriate interfaces, types, and documentation
6. Include unit tests for both components

## Context Files

- [Flow Architecture Diagram](../visualizations/prompt-flow-architecture.md)
- [Implementation Plan](../planning/flow-implementation-plan.md)
- [Architecture Decision Record](../decisions/20250423-flow-architecture.md)

## Dependencies

- Depends on the enhanced classifier service (TASK-API-20250423-142100)

## Checklist

- [‚è≥] Analyze the current router implementation
  - [‚è≥] Identify routing logic
  - [‚è≥] Identify normalization logic
  - [‚è≥] Determine extension points

- [‚è≥] Design the routing engine
  - [‚è≥] Define interfaces for routing strategies
  - [‚è≥] Design the routing engine registry
  - [‚è≥] Plan for future routing strategies (latency, cost, etc.)

- [‚è≥] Design the normalization engine
  - [‚è≥] Define interfaces for normalizers
  - [‚è≥] Design the normalization engine registry
  - [‚è≥] Plan for model-specific normalizers

- [‚è≥] Implement the routing engine
  - [‚è≥] Create base routing engine structure
  - [‚è≥] Extract current rules-based routing logic
  - [‚è≥] Implement routing strategy registry
  - [‚è≥] Add placeholder for future routing strategies

- [‚è≥] Implement the normalization engine
  - [‚è≥] Create base normalization engine structure
  - [‚è≥] Implement format conversion logic
  - [‚è≥] Implement model-specific normalizers
  - [‚è≥] Add registry for normalizers

- [‚è≥] Update the main router service
  - [‚è≥] Modify to use the new components
  - [‚è≥] Ensure backward compatibility
  - [‚è≥] Add appropriate error handling and logging

- [‚è≥] Create unit tests
  - [‚è≥] Test routing engine
  - [‚è≥] Test normalization engine
  - [‚è≥] Test the integration between components

- [‚è≥] Update documentation
  - [‚è≥] Add JSDoc comments to all functions and interfaces
  - [‚è≥] Create examples of how to add new routing strategies and normalizers

## Technical Details

### Current Structure

The current router service is implemented in `src/services/router.ts` and provides functionality to route prompts to appropriate models based on classification. It needs to be refactored to separate routing and normalization concerns.

### Proposed Structure

```
src/services/router/
‚îú‚îÄ‚îÄ index.ts                 # Main entry point
‚îú‚îÄ‚îÄ interfaces.ts            # Type definitions and interfaces
‚îú‚îÄ‚îÄ routing/                 # Routing engine
‚îÇ   ‚îú‚îÄ‚îÄ index.ts             # Routing engine entry point
‚îÇ   ‚îú‚îÄ‚îÄ registry.ts          # Routing strategy registry
‚îÇ   ‚îî‚îÄ‚îÄ strategies/          # Routing strategies
‚îÇ       ‚îú‚îÄ‚îÄ rules-based.ts   # Current rules-based strategy
‚îÇ       ‚îú‚îÄ‚îÄ latency.ts       # Placeholder for latency-based strategy
‚îÇ       ‚îî‚îÄ‚îÄ cost.ts          # Placeholder for cost-based strategy
‚îú‚îÄ‚îÄ normalization/           # Normalization engine
‚îÇ   ‚îú‚îÄ‚îÄ index.ts             # Normalization engine entry point
‚îÇ   ‚îú‚îÄ‚îÄ registry.ts          # Normalizer registry
‚îÇ   ‚îî‚îÄ‚îÄ normalizers/         # Model-specific normalizers
‚îÇ       ‚îú‚îÄ‚îÄ openai.ts        # OpenAI normalizer
‚îÇ       ‚îú‚îÄ‚îÄ anthropic.ts     # Anthropic normalizer
‚îÇ       ‚îî‚îÄ‚îÄ lmstudio.ts      # LMStudio normalizer
‚îî‚îÄ‚îÄ README.md                # Documentation
```

### Interfaces

```typescript
// Example interfaces for routing engine
export interface RoutingStrategy {
  name: string;
  route(prompt: string, classification: ClassificationResult, options?: RoutingOptions): Promise<RoutingResult>;
  isEnabled(options?: RoutingOptions): boolean;
}

export interface RoutingOptions {
  qualityOptimize?: boolean;
  costOptimize?: boolean;
  latencyOptimize?: boolean;
  [key: string]: any;
}

export interface RoutingResult {
  modelId: string;
  provider: string;
  fallbackOptions?: string[];
  metadata?: Record<string, any>;
}

// Example interfaces for normalization engine
export interface Normalizer {
  name: string;
  provider: string;
  normalize(prompt: string, options?: NormalizationOptions): Promise<string>;
  isEnabled(options?: NormalizationOptions): boolean;
}

export interface NormalizationOptions {
  modelId?: string;
  [key: string]: any;
}
```

### Implementation Notes

1. The routing engine should select the appropriate model based on the prompt classification and routing options
2. The normalization engine should prepare the prompt for the selected model
3. Both components should be designed to be easily extensible
4. The current router service should be updated to use these components while maintaining backward compatibility
5. Appropriate error handling and logging should be added throughout

üì£ Report back when the interfaces and basic structure are implemented.
üì£ Report back when the routing engine is implemented.
üì£ Report back when the normalization engine is implemented.

## Progress Updates

### 2025-04-23: Updated Router Service to Use New Components

I've updated the main router service (`src/services/router/index.ts`) to use the new routing engine and normalization engine components. The changes include:

1. Modified the `routePrompt` method to use the routing engine for model selection instead of the internal `selectModel` method
2. Enhanced the normalization process to use the normalization engine for prompt normalization
3. Updated the `routeChatCompletion` method to use both the routing engine and normalization engine
4. Removed the now-obsolete `selectModel` method as its functionality is now handled by the routing engine
5. Added appropriate logging to track the routing and normalization processes

These changes ensure that the router service now properly delegates routing and normalization responsibilities to their respective specialized components, improving modularity and maintainability while preserving backward compatibility.

Next steps:
- Complete unit tests for the routing engine, normalization engine, and their integration
- Update documentation with examples of how to add new routing strategies and normalizers

üì£ Report back when all components are integrated and tested.